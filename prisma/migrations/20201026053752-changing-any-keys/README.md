# Migration `20201026053752-changing-any-keys`

This migration has been generated by andleo17 at 10/26/2020, 12:37:52 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX "public"."Course.code_unique"

DROP INDEX "public"."Semester.name_unique"

DROP INDEX "public"."TypeActivity.name_unique"

ALTER TABLE "public"."Enrollment" DROP CONSTRAINT "Enrollment_semesterId_fkey"

ALTER TABLE "public"."Group" DROP CONSTRAINT "Group_courseId_fkey"

ALTER TABLE "public"."Group" DROP CONSTRAINT "Group_semesterId_fkey"

ALTER TABLE "public"."User" DROP CONSTRAINT "User_semesterId_fkey"

ALTER TABLE "public"."Course" DROP CONSTRAINT "Course_pkey",
DROP COLUMN "id",
ADD PRIMARY KEY ("code")

ALTER TABLE "public"."Enrollment" ALTER COLUMN "semesterId" SET DATA TYPE text 

ALTER TABLE "public"."Group" DROP COLUMN "courseId",
ADD COLUMN "courseCode" text   NOT NULL ,
ALTER COLUMN "semesterId" SET DATA TYPE text 

ALTER TABLE "public"."Semester" DROP CONSTRAINT "Semester_pkey",
DROP COLUMN "id",
ADD PRIMARY KEY ("name")

ALTER TABLE "public"."User" ALTER COLUMN "semesterId" SET DATA TYPE text 

CREATE TABLE "public"."_CoursesPrerequisites" (
"A" text   NOT NULL ,
"B" text   NOT NULL 
)

CREATE UNIQUE INDEX "_CoursesPrerequisites_AB_unique" ON "public"."_CoursesPrerequisites"("A", "B")

CREATE INDEX "_CoursesPrerequisites_B_index" ON "public"."_CoursesPrerequisites"("B")

CREATE UNIQUE INDEX "Enrollment.userId_semesterId_unique" ON "public"."Enrollment"("userId", "semesterId")

CREATE UNIQUE INDEX "EnrollmentDetail.enrollmentId_groupId_unique" ON "public"."EnrollmentDetail"("enrollmentId", "groupId")

CREATE UNIQUE INDEX "Grade.activityId_enrollmentDetailId_unique" ON "public"."Grade"("activityId", "enrollmentDetailId")

CREATE UNIQUE INDEX "Group.denomination_courseCode_teacherId_semesterId_unique" ON "public"."Group"("denomination", "courseCode", "teacherId", "semesterId")

ALTER TABLE "public"."_CoursesPrerequisites" ADD FOREIGN KEY ("A")REFERENCES "public"."Course"("code") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_CoursesPrerequisites" ADD FOREIGN KEY ("B")REFERENCES "public"."Course"("code") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Enrollment" ADD FOREIGN KEY ("semesterId")REFERENCES "public"."Semester"("name") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Group" ADD FOREIGN KEY ("courseCode")REFERENCES "public"."Course"("code") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Group" ADD FOREIGN KEY ("semesterId")REFERENCES "public"."Semester"("name") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."User" ADD FOREIGN KEY ("semesterId")REFERENCES "public"."Semester"("name") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201026030141-add-unique-constraint-to-user-table..20201026053752-changing-any-keys
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -27,10 +27,9 @@
   courses   Course[]
 }
 model Semester {
-  id          Int          @id @default(autoincrement())
-  name        String       @unique
+  name        String       @id
   startDate   DateTime?
   finishDate  DateTime?
   state       Boolean      @default(false)
   users       User[]
@@ -47,25 +46,26 @@
   lastname    String
   birthDate   DateTime
   photo       String
   genre       Boolean
-  semesterId  Int
-  semester    Semester     @relation(fields: [semesterId], references: [id])
+  semesterId  String
+  semester    Semester     @relation(fields: [semesterId], references: [name])
   schoolId    Int
   school      School       @relation(fields: [schoolId], references: [id])
   enrollments Enrollment[]
 }
 model Course {
-  id            Int     @id @default(autoincrement())
-  name          String
-  code          String  @unique
-  credits       Int
-  academicPhase Int
-  state         Boolean @default(true)
-  schoolId      Int
-  school        School  @relation(fields: [schoolId], references: [id])
-  groups        Group[]
+  code                String   @id
+  name                String
+  credits             Int
+  academicPhase       Int
+  state               Boolean  @default(true)
+  schoolId            Int
+  school              School   @relation(fields: [schoolId], references: [id])
+  groups              Group[]
+  coursePrerequisites Course[] @relation("CoursesPrerequisites", references: [code])
+  prerequisitesOf     Course[] @relation("CoursesPrerequisites", references: [code])
 }
 model Teacher {
   id       Int     @id @default(autoincrement())
@@ -78,28 +78,32 @@
 model Group {
   id                Int                @id @default(autoincrement())
   denomination      String
   state             Boolean            @default(true)
-  courseId          Int
-  course            Course             @relation(fields: [courseId], references: [id])
+  courseCode        String
+  course            Course             @relation(fields: [courseCode], references: [code])
   teacherId         Int
   teacher           Teacher            @relation(fields: [teacherId], references: [id])
-  semesterId        Int
-  semester          Semester           @relation(fields: [semesterId], references: [id])
+  semesterId        String
+  semester          Semester           @relation(fields: [semesterId], references: [name])
   enrollmentDetails EnrollmentDetail[]
   activities        Activity[]
   schedules         Schedule[]
+
+  @@unique([denomination, courseCode, teacherId, semesterId])
 }
 model Enrollment {
   id                Int                @id @default(autoincrement())
   weightedAverage   Int?
   state             Boolean            @default(true)
   userId            Int
   user              User               @relation(fields: [userId], references: [id])
-  semesterId        Int
-  semester          Semester           @relation(fields: [semesterId], references: [id])
+  semesterId        String
+  semester          Semester           @relation(fields: [semesterId], references: [name])
   enrollmentDetails EnrollmentDetail[]
+
+  @@unique([userId, semesterId])
 }
 model EnrollmentDetail {
   id           Int        @id @default(autoincrement())
@@ -109,13 +113,15 @@
   enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
   groupId      Int
   group        Group      @relation(fields: [groupId], references: [id])
   grades       Grade[]
+
+  @@unique([enrollmentId, groupId])
 }
 model TypeActivity {
   id         Int        @id @default(autoincrement())
-  name       String     @unique
+  name       String
   activities Activity[]
 }
 model Activity {
@@ -142,8 +148,10 @@
   activityId         Int
   activity           Activity         @relation(fields: [activityId], references: [id])
   enrollmentDetailId Int
   enrollmentDetail   EnrollmentDetail @relation(fields: [enrollmentDetailId], references: [id])
+
+  @@unique([activityId, enrollmentDetailId])
 }
 model Schedule {
   id         Int      @id @default(autoincrement())
```


