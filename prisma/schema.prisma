// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  output        = "./@client"
  binaryTargets = "native"
}

model Faculty {
  id      Int      @id @default(autoincrement())
  name    String   @unique
  state   Boolean  @default(true)
  schools School[]
}

model School {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  state     Boolean  @default(true)
  facultyId Int
  faculty   Faculty  @relation(fields: [facultyId], references: [id])
  users     User[]
  courses   Course[]
}

model Semester {
  name        String       @id
  startDate   DateTime?
  finishDate  DateTime?
  state       Boolean      @default(false)
  users       User[]
  groups      Group[]
  enrollments Enrollment[]
}

model User {
  id          Int          @id @default(autoincrement())
  nickname    String       @unique
  password    String
  email       String       @unique
  name        String
  lastname    String
  birthDate   DateTime
  photo       String
  genre       Boolean
  state       Boolean      @default(true)
  semesterId  String
  semester    Semester     @relation(fields: [semesterId], references: [name])
  schoolId    Int
  school      School       @relation(fields: [schoolId], references: [id])
  enrollments Enrollment[]
}

model Course {
  code                String   @id
  name                String
  credits             Int
  academicPhase       Int
  state               Boolean  @default(true)
  schoolId            Int
  school              School   @relation(fields: [schoolId], references: [id])
  groups              Group[]
  coursePrerequisites Course[] @relation("CoursesPrerequisites", references: [code])
  prerequisitesOf     Course[] @relation("CoursesPrerequisites", references: [code])
}

model Teacher {
  id       Int     @id @default(autoincrement())
  name     String
  lastname String
  state    Boolean @default(true)
  groups   Group[]
}

model Group {
  id                Int                @id @default(autoincrement())
  denomination      String
  state             Boolean            @default(true)
  courseCode        String
  course            Course             @relation(fields: [courseCode], references: [code])
  teacherId         Int
  teacher           Teacher            @relation(fields: [teacherId], references: [id])
  semesterId        String
  semester          Semester           @relation(fields: [semesterId], references: [name])
  enrollmentDetails EnrollmentDetail[]
  activities        Activity[]
  schedules         Schedule[]

  @@unique([denomination, courseCode, teacherId, semesterId])
}

model Enrollment {
  id                Int                @id @default(autoincrement())
  weightedAverage   Int?
  state             Boolean            @default(true)
  userId            Int
  user              User               @relation(fields: [userId], references: [id])
  semesterId        String
  semester          Semester           @relation(fields: [semesterId], references: [name])
  enrollmentDetails EnrollmentDetail[]

  @@unique([userId, semesterId])
}

model EnrollmentDetail {
  id           Int        @id @default(autoincrement())
  averageGrade Float?
  state        Boolean    @default(true)
  enrollmentId Int
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
  groupId      Int
  group        Group      @relation(fields: [groupId], references: [id])
  grades       Grade[]

  @@unique([enrollmentId, groupId])
}

model TypeActivity {
  id         Int        @id @default(autoincrement())
  name       String
  activities Activity[]
}

model Activity {
  id               Int          @id @default(autoincrement())
  name             String
  weight           Float
  presentationDate DateTime?
  state            Boolean      @default(true)
  typeActivityId   Int
  typeActivity     TypeActivity @relation(fields: [typeActivityId], references: [id])
  activityId       Int?
  parentActivity   Activity?    @relation("ActivityToActivity", fields: [activityId], references: [id])
  groupId          Int
  group            Group        @relation(fields: [groupId], references: [id])
  childActivities  Activity[]   @relation("ActivityToActivity")
  grades           Grade[]
}

model Grade {
  id                 Int              @id @default(autoincrement())
  calification       Float?
  confirmated        Boolean          @default(false)
  state              Boolean          @default(true)
  activityId         Int
  activity           Activity         @relation(fields: [activityId], references: [id])
  enrollmentDetailId Int
  enrollmentDetail   EnrollmentDetail @relation(fields: [enrollmentDetailId], references: [id])

  @@unique([activityId, enrollmentDetailId])
}

model Schedule {
  id         Int      @id @default(autoincrement())
  day        Int
  startHour  DateTime
  finishHour DateTime
  state      Boolean  @default(true)
  groupId    Int
  group      Group    @relation(fields: [groupId], references: [id])
}
